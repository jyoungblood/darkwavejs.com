---
const currentPath = Astro.url.pathname;

const navLinks = [
  { href: "/docs/", label: "Docs" },
  { href: "/fieldguide/", label: "Field Guide" },
  { href: "/blog/", label: "Blog" },
  { href: "/project/", label: "Project" },
];
---

<nav class="relative py-6 border-b border-neutral-800 mb-12">
  <!-- Mobile Nav (visible on small screens only) -->
  <div class="flex sm:hidden items-center gap-3">
    <!-- Logo -->
    <a href="/" class="block flex-shrink-0">
      <img src="/images/dw-triangles-white.svg" alt="Darkwave" class="h-7" />
    </a>

    <!-- Spacer -->
    <div class="flex-1"></div>

    <!-- Search Button -->
    <button
      id="search-button-mobile"
      class="flex items-center justify-center flex-shrink-0 w-10 h-10 text-neutral-400 hover:text-dw-green transition-colors"
      type="button"
      aria-label="Open search"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 512 512">
        <path fill="currentColor" d="M416 208c0 45.9-14.9 88.3-40 122.7l126.6 126.7c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0s208 93.1 208 208M208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288"/>
      </svg>
    </button>

    <!-- Hamburger Menu Button -->
    <button
      id="mobile-menu-toggle"
      class="flex items-center justify-center flex-shrink-0 w-10 h-10 text-neutral-400 hover:text-dw-green transition-colors"
      type="button"
      aria-label="Toggle menu"
    >
      <svg id="hamburger-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
      <svg id="close-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- Desktop/Tablet Nav (visible on small screens and up) -->
  <div class="hidden sm:flex items-center justify-between">
    <div class="flex items-center gap-4">
      <a href="/" class="block">
        <img src="/images/dw-triangles-white.svg" alt="Darkwave" class="h-8" />
      </a>

      <!-- Search Button -->
      <button
        id="search-button"
        class="flex items-center gap-2 w-56 md:w-64 px-3 py-2 text-sm text-neutral-400 bg-neutral-900 border border-neutral-800 rounded-md hover:border-neutral-700 hover:text-white transition-colors"
        type="button"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 512 512">
          <path fill="currentColor" d="M416 208c0 45.9-14.9 88.3-40 122.7l126.6 126.7c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0s208 93.1 208 208M208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288"/>
        </svg>
        <span class="flex-1 text-left">Search</span>
        <kbd class="ml-2 inline-flex items-center gap-1 px-1.5 py-0.5 text-xs bg-neutral-800 rounded border border-neutral-700">
          <span class="text-xs">âŒ˜</span>K
        </kbd>
      </button>
    </div>

    <div class="flex items-center gap-6">
      <!-- Nav Links -->
      {navLinks.map((link) => {
        const normalizePath = (path: string) =>
          path !== "/" && path.endsWith("/") ? path.slice(0, -1) : path;
        const isActive = normalizePath(currentPath).startsWith(
          normalizePath(link.href)
        );
        return (
          <a
            href={link.href}
            class:list={[
              "text-sm font-medium transition-colors",
              isActive
                ? "text-dw-green"
                : "text-neutral-400 hover:text-dw-green"
            ]}
          >
            {link.label}
          </a>
        );
      })}
    </div>
  </div>

  <!-- Mobile Menu Backdrop - dims and blurs background (below nav only) -->
  <div
    id="mobile-menu-backdrop"
    class="sm:hidden hidden fixed left-0 right-0 bottom-0 bg-black/60 backdrop-blur-sm z-[60] transition-opacity duration-200"
  ></div>

  <!-- Mobile Menu Dropdown - Absolute positioned overlay -->
  <div
    id="mobile-menu"
    class="sm:hidden hidden absolute top-full left-0 right-0 -mt-px bg-neutral-900 border border-neutral-800 rounded-md z-[70]"
  >
    <div class="flex flex-col gap-1 p-4">
      {navLinks.map((link) => {
        const normalizePath = (path: string) =>
          path !== "/" && path.endsWith("/") ? path.slice(0, -1) : path;
        const isActive = normalizePath(currentPath).startsWith(
          normalizePath(link.href)
        );
        return (
          <a
            href={link.href}
            class:list={[
              "block px-3 py-2 text-sm font-medium transition-colors rounded",
              isActive
                ? "text-dw-green bg-neutral-800"
                : "text-neutral-400 hover:text-dw-green hover:bg-neutral-800/50"
            ]}
          >
            {link.label}
          </a>
        );
      })}
    </div>
  </div>
</nav>

<!-- Search Modal -->
<div id="search-modal" class="hidden fixed inset-0 z-50">
  <!-- Backdrop that covers entire screen and handles close on click/touch -->
  <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" id="search-backdrop"></div>
  <!-- Content wrapper - absolute to ensure full coverage for touch events -->
  <div class="absolute inset-0 flex items-start justify-center pt-[15vh] pointer-events-none">
    <div class="w-full max-w-2xl mx-4 bg-neutral-900 rounded-lg border border-neutral-700 shadow-2xl overflow-hidden pointer-events-auto">
      <div class="p-4 border-b border-neutral-700">
        <div class="flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-neutral-400" viewBox="0 0 512 512">
            <path fill="currentColor" d="M416 208c0 45.9-14.9 88.3-40 122.7l126.6 126.7c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0s208 93.1 208 208M208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288"/>
          </svg>
          <input
            type="text"
            id="search-input"
            placeholder="Search documentation..."
            class="flex-1 bg-transparent text-white placeholder-neutral-500 outline-none text-lg"
            autocomplete="off"
          />
          <kbd class="px-2 py-1 text-xs bg-neutral-800 rounded border border-neutral-700 text-neutral-400">ESC</kbd>
        </div>
      </div>
      <div id="search-results" class="max-h-[60vh] overflow-y-auto p-2">
        <div class="text-neutral-500 text-sm p-4 text-center">
          Type to search across all documentation...
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Mobile Menu functionality
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileMenuBackdrop = document.getElementById('mobile-menu-backdrop') as HTMLElement;
  const hamburgerIcon = document.getElementById('hamburger-icon');
  const closeIcon = document.getElementById('close-icon');
  const navElement = document.querySelector('nav');

  function openMobileMenu() {
    // Position backdrop to start below the nav
    if (mobileMenuBackdrop && navElement) {
      const navRect = navElement.getBoundingClientRect();
      mobileMenuBackdrop.style.top = `${navRect.bottom}px`;
    }
    mobileMenu?.classList.remove('hidden');
    mobileMenuBackdrop?.classList.remove('hidden');
    hamburgerIcon?.classList.add('hidden');
    closeIcon?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeMobileMenu() {
    mobileMenu?.classList.add('hidden');
    mobileMenuBackdrop?.classList.add('hidden');
    hamburgerIcon?.classList.remove('hidden');
    closeIcon?.classList.add('hidden');
    document.body.style.overflow = '';
  }

  mobileMenuToggle?.addEventListener('click', () => {
    const isHidden = mobileMenu?.classList.contains('hidden');
    if (isHidden) {
      openMobileMenu();
    } else {
      closeMobileMenu();
    }
  });

  // Close mobile menu when clicking backdrop
  mobileMenuBackdrop?.addEventListener('click', closeMobileMenu);

  // Search Modal functionality
  const searchButton = document.getElementById('search-button');
  const searchButtonMobile = document.getElementById('search-button-mobile');
  const searchModal = document.getElementById('search-modal');
  const searchBackdrop = document.getElementById('search-backdrop');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchResults = document.getElementById('search-results');

  let pagefind: any = null;

  async function initPagefind() {
    if (pagefind) return pagefind;
    try {
      // Construct path at runtime to avoid Vite bundling
      const pagefindPath = ['/pagefind', '/pagefind.js'].join('');
      pagefind = await import(/* @vite-ignore */ pagefindPath);
      await pagefind.init();
      return pagefind;
    } catch (e) {
      console.log('Pagefind not available yet');
      return null;
    }
  }

  function openSearch() {
    searchModal?.classList.remove('hidden');
    searchInput?.focus();
    document.body.style.overflow = 'hidden';
    initPagefind();
  }

  function closeSearch() {
    searchModal?.classList.add('hidden');
    document.body.style.overflow = '';
    if (searchInput) searchInput.value = '';
    if (searchResults) {
      searchResults.innerHTML = '<div class="text-neutral-500 text-sm p-4 text-center">Type to search across all documentation...</div>';
    }
  }

  searchButton?.addEventListener('click', openSearch);
  searchButtonMobile?.addEventListener('click', openSearch);

  // Close search when clicking/touching the backdrop
  searchBackdrop?.addEventListener('click', closeSearch);

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      openSearch();
    }
    if (e.key === 'Escape') {
      closeSearch();
    }
  });

  // Search functionality
  let searchTimeout: ReturnType<typeof setTimeout>;
  searchInput?.addEventListener('input', async (e) => {
    const query = (e.target as HTMLInputElement).value;

    clearTimeout(searchTimeout);

    if (!query || query.length < 2) {
      if (searchResults) {
        searchResults.innerHTML = '<div class="text-neutral-500 text-sm p-4 text-center">Type to search across all documentation...</div>';
      }
      return;
    }

    searchTimeout = setTimeout(async () => {
      const pf = await initPagefind();
      if (!pf) {
        if (searchResults) {
          searchResults.innerHTML = '<div class="text-neutral-500 text-sm p-4 text-center">Search is loading...</div>';
        }
        return;
      }

      const search = await pf.search(query);

      if (search.results.length === 0) {
        if (searchResults) {
          searchResults.innerHTML = '<div class="text-neutral-500 text-sm p-4 text-center">No results found</div>';
        }
        return;
      }

      const results = await Promise.all(
        search.results.slice(0, 10).map((r: any) => r.data())
      );

      if (searchResults) {
        searchResults.innerHTML = results.map((result: any) => `
          <a href="${result.url}" class="block p-3 rounded-lg hover:bg-neutral-800 transition-colors group">
            <div class="font-medium text-white group-hover:text-dw-green transition-colors">${result.meta?.title || result.url}</div>
            <div class="text-sm text-neutral-400 mt-1 line-clamp-2">${result.excerpt}</div>
          </a>
        `).join('');
      }
    }, 150);
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
