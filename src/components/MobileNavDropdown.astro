---
/**
 * Mobile navigation dropdown component.
 * Handles both sectioned navigation (docs) and flat lists (fieldguide).
 */
interface Props {
  /** Unique identifier for the dropdown */
  id: string;
  /** Current page title shown in collapsed state */
  currentTitle: string;
  /** Optional header label shown inside the dropdown */
  label?: string;
}

const { id, currentTitle, label } = Astro.props;
---

<div class={`mobile-nav-dropdown mobile-nav-dropdown-${id} sm:hidden mb-6 relative`}>
  <button
    class="mobile-nav-toggle w-full flex items-center justify-between px-4 py-3 text-sm font-medium text-neutral-100 bg-neutral-900 border border-neutral-800 rounded-md hover:border-neutral-700 transition-colors"
    type="button"
    aria-expanded="false"
  >
    <span>{currentTitle}</span>
    <svg
      class="mobile-nav-chevron w-4 h-4 transition-transform"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    >
      <path d="M9 18l6-6-6-6" />
    </svg>
  </button>

  <nav
    class="mobile-nav-content hidden absolute top-full left-0 right-0 mt-2 p-4 bg-neutral-900 border border-neutral-800 rounded-md max-h-[70vh] overflow-y-auto z-50 space-y-4"
  >
    {label && <h2 class="text-xs font-semibold text-neutral-400 uppercase tracking-wide mb-3">{label}</h2>}
    <slot />
  </nav>
</div>

<script>
  // Helper to close a specific dropdown
  function closeDropdown(container: Element) {
    const dropdown = container.querySelector('.mobile-nav-content');
    const chevron = container.querySelector('.mobile-nav-chevron');
    const toggle = container.querySelector('.mobile-nav-toggle');

    dropdown?.classList.add('hidden');
    if (chevron) (chevron as HTMLElement).style.transform = '';
    toggle?.setAttribute('aria-expanded', 'false');
  }

  // Close all dropdowns on the page
  function closeAllMobileNavDropdowns() {
    document.querySelectorAll('.mobile-nav-dropdown').forEach(closeDropdown);
  }

  // Document-level click handler (added once)
  function handleDocumentClick(e: MouseEvent) {
    const target = e.target as Element;
    // Check if click is outside all dropdowns
    if (!target.closest('.mobile-nav-dropdown')) {
      closeAllMobileNavDropdowns();
    }
  }

  function initMobileNavDropdowns() {
    const dropdowns = document.querySelectorAll('.mobile-nav-dropdown');

    dropdowns.forEach(container => {
      const toggle = container.querySelector('.mobile-nav-toggle');
      const dropdown = container.querySelector('.mobile-nav-content');
      const chevron = container.querySelector('.mobile-nav-chevron');

      // Skip if already initialized
      if (toggle?.hasAttribute('data-dropdown-init')) return;
      toggle?.setAttribute('data-dropdown-init', 'true');

      toggle?.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent document click from immediately closing
        const isHidden = dropdown?.classList.contains('hidden');

        // Close any other open dropdowns first
        dropdowns.forEach(other => {
          if (other !== container) closeDropdown(other);
        });

        if (isHidden) {
          dropdown?.classList.remove('hidden');
          if (chevron) (chevron as HTMLElement).style.transform = 'rotate(90deg)';
          toggle.setAttribute('aria-expanded', 'true');
        } else {
          dropdown?.classList.add('hidden');
          if (chevron) (chevron as HTMLElement).style.transform = '';
          toggle.setAttribute('aria-expanded', 'false');
        }
      });

      // Prevent clicks inside the dropdown content from closing it
      dropdown?.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    });

    // Collapsible sections within mobile dropdowns
    document.querySelectorAll('.nav-section-toggle-mobile').forEach(button => {
      // Skip if already initialized
      if (button.hasAttribute('data-section-init')) return;
      button.setAttribute('data-section-init', 'true');

      button.addEventListener('click', () => {
        const section = button.closest('.nav-section-mobile');
        const content = section?.querySelector('.nav-section-content-mobile');
        const chevron = button.querySelector('.section-chevron-mobile');
        const isExpanded = button.getAttribute('aria-expanded') === 'true';

        if (content) {
          (content as HTMLElement).style.display = isExpanded ? 'none' : '';
        }
        if (chevron) {
          (chevron as HTMLElement).style.transform = isExpanded ? '' : 'rotate(90deg)';
        }
        button.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
      });
    });
  }

  // Add document click handler once
  document.addEventListener('click', handleDocumentClick);

  // Run on initial load and on Astro page transitions
  document.addEventListener('DOMContentLoaded', initMobileNavDropdowns);
  document.addEventListener('astro:page-load', initMobileNavDropdowns);
</script>
